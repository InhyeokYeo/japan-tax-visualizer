<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ãªãŸã®æ‰‹å–ã‚Šã¨ç¨é‡‘ã€ã©ã†ãªã£ã¦ã‚‹ï¼ŸğŸ’° | ç¨ãƒ»ç¤¾ä¼šä¿éšœãƒ»æ‰‹å–ã‚Š è¦‹ãˆã‚‹åŒ–ã‚µã‚¤ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.jsã®ãƒ‡ãƒ¼ã‚¿ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¿½åŠ  -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .result-card {
            transition: all 0.3s ease-in-out;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .result-card-container {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .result-card-container.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        input[type=tel] {
            -moz-appearance: textfield;
        }
        .btn-primary {
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover {
            transform: scale(1.02);
        }
         .btn-primary:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg border-b border-slate-200 shadow-sm">
        <div class="container mx-auto px-4 py-3">
            <h1 class="text-xl md:text-2xl font-bold text-slate-900">ã‚ãªãŸã®æ‰‹å–ã‚Šã¨ç¨é‡‘ã€ã©ã†ãªã£ã¦ã‚‹ï¼ŸğŸ’°</h1>
            <p class="text-sm text-slate-600">ç¨ãƒ»ç¤¾ä¼šä¿éšœãƒ»æ‰‹å–ã‚Š è¦‹ãˆã‚‹åŒ–ã‚µã‚¤ãƒˆ</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 md:py-12">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Input Section -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 lg:sticky top-6">
                    <h3 class="text-2xl font-bold mb-6 text-slate-800">ã‚ãªãŸã®æƒ…å ±ã‚’å…¥åŠ›</h3>

                    <div class="space-y-4">
                        <!-- å¹´å -->
                        <div>
                            <label for="annual-income" class="block text-sm font-medium text-slate-700 mb-1">ã‚ãªãŸã®å¹´åï¼ˆé¡é¢ï¼‰</label>
                            <div class="flex items-baseline bg-slate-100 rounded-lg focus-within:ring-2 focus-within:ring-indigo-400 p-3">
                                <input type="tel" inputmode="numeric" pattern="[0-9,]*" id="annual-income" class="flex-1 w-full bg-transparent text-2xl font-bold text-indigo-600 focus:outline-none" placeholder="ä¾‹: 500">
                                <span class="text-lg font-semibold text-slate-600 ml-2">ä¸‡å††</span>
                            </div>
                        </div>
                        <!-- å¹´é½¢ -->
                        <div>
                            <label for="age" class="block text-sm font-medium text-slate-700 mb-1">å¹´é½¢</label>
                            <div class="flex items-baseline bg-slate-100 rounded-lg focus-within:ring-2 focus-within:ring-indigo-400 p-3">
                                <input type="tel" inputmode="numeric" pattern="[0-9]*" id="age" class="flex-1 w-full bg-transparent text-2xl font-bold text-slate-800 focus:outline-none" placeholder="ä¾‹: 35">
                                <span class="text-lg font-semibold text-slate-600 ml-2">æ­³</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è©³ç´°è¨­å®šãƒˆã‚°ãƒ« -->
                    <details class="group mt-6">
                        <summary class="text-lg font-semibold text-slate-700 cursor-pointer list-none flex justify-between items-center p-2 rounded-lg hover:bg-slate-100">
                            <span>è©³ç´°è¨­å®š</span>
                            <svg class="w-5 h-5 transition-transform duration-300 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </summary>

                        <div class="mt-6 space-y-4">
                            <!-- åƒãæ–¹ -->
                            <div>
                                <label for="work-type" class="block text-sm font-medium text-slate-600">åƒãæ–¹</label>
                                <select id="work-type" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none">
                                    <option value="company-employee">ä¼šç¤¾å“¡ãƒ»å…¬å‹™å“¡</option>
                                    <option value="freelance">è‡ªå–¶æ¥­ãƒ»ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹</option>
                                </select>
                            </div>
                            <!-- å±…ä½åœ° -->
                            <div>
                                <label for="prefecture" class="block text-sm font-medium text-slate-600">ãŠä½ã¾ã„ã®éƒ½é“åºœçœŒ</label>
                                <select id="prefecture" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none">
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                            <!-- å®¶æ—æ§‹æˆ -->
                            <div class="pt-4 border-t">
                                <p class="text-sm font-medium text-slate-600 mb-2">å®¶æ—æ§‹æˆ</p>
                                <div class="space-y-4">
                                    <div>
                                        <label for="spouse" class="block text-xs text-slate-500">é…å¶è€…</label>
                                        <select id="spouse" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none">
                                            <option value="none">ã„ãªã„ / å…±åƒã(é…å¶è€…å¹´å150ä¸‡è¶…)</option>
                                            <option value="dependent">ã„ã‚‹ (å°‚æ¥­ä¸»å©¦ãƒ»ä¸»å¤« / å¹´å150ä¸‡ä»¥ä¸‹)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="dependents-jhs" class="block text-xs text-slate-500">æ‰¶é¤Šã—ã¦ã„ã‚‹å­ã©ã‚‚ï¼ˆä¸­å­¦ç”Ÿä»¥ä¸‹ï¼‰</label>
                                        <select id="dependents-jhs" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none">
                                            <option value="0">0äºº</option>
                                            <option value="1">1äºº</option>
                                            <option value="2">2äºº</option>
                                            <option value="3">3äººä»¥ä¸Š</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="dependents-hs" class="block text-xs text-slate-500">æ‰¶é¤Šã—ã¦ã„ã‚‹å­ã©ã‚‚ï¼ˆé«˜æ ¡ç”Ÿã®å¹´ä»£ï¼‰</label>
                                        <select id="dependents-hs" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none">
                                            <option value="0">0äºº</option>
                                            <option value="1">1äºº</option>
                                            <option value="2">2äºº</option>
                                            <option value="3">3äººä»¥ä¸Š</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="dependents-specific" class="block text-xs text-slate-500">æ‰¶é¤Šã—ã¦ã„ã‚‹è¦ªæ—ï¼ˆå¤§å­¦ç”Ÿãªã©19æ­³ã€œ69æ­³ï¼‰</label>
                                        <select id="dependents-specific" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none">
                                            <option value="0">0äºº</option>
                                            <option value="1">1äºº</option>
                                            <option value="2">2äºº</option>
                                            <option value="3">3äººä»¥ä¸Š</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="dependents-elderly" class="block text-xs text-slate-500">æ‰¶é¤Šã—ã¦ã„ã‚‹è¦ªæ—ï¼ˆ70æ­³ä»¥ä¸Šï¼‰</label>
                                        <select id="dependents-elderly" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none">
                                            <option value="0">0äºº</option>
                                            <option value="1">1äºº</option>
                                            <option value="2">2äºº</option>
                                            <option value="3">3äººä»¥ä¸Š</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ« -->
                            <div class="pt-4 border-t">
                                <p class="text-sm font-medium text-slate-600 mb-2">ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãã®ä»–è«¸ç¨ã®æ¨è¨ˆã«ä½¿ç”¨ï¼‰</p>
                                <div class="space-y-4">
                                    <div><label for="home-ownership" class="block text-xs text-slate-500">ä¸å‹•ç”£æ‰€æœ‰ï¼ˆå›ºå®šè³‡ç”£ç¨ãªã©ï¼‰</label><select id="home-ownership" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none"><option value="none">è³ƒè²¸</option><option value="owned_low">æŒã¡å®¶ï¼ˆè©•ä¾¡é¡2,000ä¸‡å††æœªæº€ï¼‰</option><option value="owned_high">æŒã¡å®¶ï¼ˆè©•ä¾¡é¡2,000ä¸‡å††ä»¥ä¸Šï¼‰</option></select></div>
                                    <div><label for="car-ownership" class="block text-xs text-slate-500">è‡ªå‹•è»Šï¼ˆè‡ªå‹•è»Šç¨ãƒ»é‡é‡ç¨ãªã©ï¼‰</label><select id="car-ownership" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none"><option value="none">æ‰€æœ‰ã—ã¦ã„ãªã„</option><option value="light">è»½è‡ªå‹•è»Š</option><option value="normal">æ™®é€šè‡ªå‹•è»Š</option></select></div>
                                    <div><label for="smoking-habit" class="block text-xs text-slate-500">å–«ç…™ï¼ˆãŸã°ã“ç¨ï¼‰</label><select id="smoking-habit" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none"><option value="none">å¸ã‚ãªã„</option><option value="sometimes">æ™‚ã€…å¸ã†</option><option value="daily">æ¯æ—¥å¸ã†</option></select></div>
                                    <div><label for="drinking-habit" class="block text-xs text-slate-500">é£²é…’ï¼ˆé…’ç¨ï¼‰</label><select id="drinking-habit" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none"><option value="none">é£²ã¾ãªã„</option><option value="sometimes">é€±ã«1ã€œ2å›é£²ã‚€</option><option value="often">é€±ã«3å›ä»¥ä¸Šé£²ã‚€</option></select></div>
                                    <div><label for="golf-habit" class="block text-xs text-slate-500">ã‚´ãƒ«ãƒ•ï¼ˆã‚´ãƒ«ãƒ•å ´åˆ©ç”¨ç¨ï¼‰</label><select id="golf-habit" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none"><option value="none">ã—ãªã„</option><option value="sometimes">æ™‚ã€…ã™ã‚‹ï¼ˆå¹´10å›ç¨‹åº¦ï¼‰</option><option value="often">é »ç¹ã«ã™ã‚‹ï¼ˆå¹´30å›ç¨‹åº¦ï¼‰</option></select></div>
                                </div>
                            </div>
                            <!-- å¹´é‡‘å—çµ¦ -->
                            <div id="pension-input-container" class="pt-4 border-t hidden">
                                <p class="text-sm font-medium text-slate-600 mb-2">å¹´é‡‘</p>
                                <div>
                                    <label for="is-pension-recipient" class="block text-xs text-slate-500">å…¬çš„å¹´é‡‘ã‚’å—çµ¦ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ</label>
                                    <select id="is-pension-recipient" class="w-full mt-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 focus:outline-none">
                                        <option value="no">ã„ã„ãˆ</option>
                                        <option value="yes">ã¯ã„</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <button id="calculate-btn" class="w-full mt-8 bg-indigo-600 text-white font-bold text-lg py-3 rounded-lg hover:bg-indigo-700 transition-colors duration-300 shadow-lg shadow-indigo-500/30 btn-primary">
                        ã“ã®å†…å®¹ã§è¨ˆç®—ã™ã‚‹
                    </button>

                    <div class="mt-4 text-xs text-slate-500">
                        <p>â€»ã“ã‚Œã¯ã‚ãã¾ã§æ¦‚ç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚å®Ÿéš›ã®é‡‘é¡ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
                    </div>
                </div>
            </div>

            <!-- Result Section -->
            <div id="result-container" class="lg:col-span-2 space-y-8 result-card-container">
                <!-- Story-based Summary -->
                <div class="result-card bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="text-xl font-bold mb-4 text-slate-800">ã‚ãªãŸã®ãŠé‡‘ã®æµã‚Œï¼ˆå¹´é–“ï¼‰</h3>
                    <div class="space-y-6">
                        <!-- æ‰‹å–ã‚Š -->
                        <div class="p-5 bg-green-50 rounded-xl border border-green-200 flex items-start space-x-4">
                            <div class="flex-shrink-0 h-10 w-10 bg-green-100 rounded-full flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-lg font-semibold text-green-800">ã‚ãªãŸã®æ‰‹å–ã‚Šé¡ï¼ˆå¯å‡¦åˆ†æ‰€å¾—ï¼‰</p>
                                <p id="net-income" class="text-4xl font-extrabold text-green-600 mt-1">---ä¸‡å††</p>
                            </div>
                        </div>
                        <!-- æ§é™¤ -->
                        <div class="p-5 bg-red-50 rounded-xl border border-red-200">
                            <div class="flex items-start space-x-4">
                                <div class="flex-shrink-0 h-10 w-10 bg-red-100 rounded-full flex items-center justify-center">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-red-800">ï¼ˆå¹´åã‹ã‚‰ã€ä¸»ã«ä¸‹è¨˜ãŒæ§é™¤ã•ã‚Œã‚‹ãŸã‚ã§ã™ï¼‰</p>
                                    <div id="burden-breakdown-summary" class="text-lg text-red-800 mt-2"></div>
                                </div>
                            </div>
                        </div>
                        <!-- ã‚µãƒãƒ¼ãƒˆ -->
                        <div class="p-5 bg-blue-50 rounded-xl border border-blue-200">
                            <div class="flex items-start space-x-4">
                               <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 2L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-3z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-blue-800">ï¼ˆä¸€æ–¹ã§ã€ã‚ãªãŸãŒå—ã‘ã‚‰ã‚Œã‚‹ä¸»ãªå…¬çš„ã‚µãƒãƒ¼ãƒˆã¯ã“ã¡ã‚‰ã§ã™ï¼‰</p>
                                    <p id="summary-benefit" class="text-lg text-blue-800 mt-2">å…¬çš„ã‚µãƒãƒ¼ãƒˆåˆè¨ˆ <span class="text-2xl font-bold">---ä¸‡å††</span></p>
                                    <div id="benefit-breakdown" class="mt-2 space-y-1"></div>
                                </div>
                            </div>
                        </div>
                         <!-- ç´”è² æ‹… -->
                         <div class="p-5 bg-slate-100 rounded-xl mt-6 border-t-4 border-slate-300">
                            <h4 class="font-semibold text-slate-600 mb-2">ã‚ãªãŸã®ç¤¾ä¼šã¸ã®è²¢çŒ®é¡ï¼ˆç´”è² æ‹…ï¼‰
                                <div class="tooltip inline-block">
                                    <span class="text-xs bg-slate-200 text-slate-600 rounded-full px-2 py-0.5">?</span>
                                    <span class="tooltip-text">ã‚ãªãŸãŒæ”¯æ‰•ã£ãŸç¨é‡‘ãƒ»ç¤¾ä¼šä¿é™ºæ–™ã‹ã‚‰ã€ã‚ãªãŸãŒå—ã‘ã‚‰ã‚Œã‚‹å¹³å‡çš„ãªå…¬çš„ã‚µãƒãƒ¼ãƒˆã‚’å·®ã—å¼•ã„ãŸã€ç¤¾ä¼šå…¨ä½“ã¸ã®å®Ÿè³ªçš„ãªè²¢çŒ®é¡ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚</span>
                                </div>
                            </h4>
                            <p id="net-contribution" class="text-4xl font-extrabold text-slate-700">---ä¸‡å††</p>
                            <p id="net-contribution-detail" class="text-slate-500 mt-1 text-sm">ï¼ˆç·è² æ‹…é¡ - å…¬çš„ã‚µãƒãƒ¼ãƒˆåˆè¨ˆï¼‰</p>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="result-card bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h4 class="font-semibold text-slate-600 mb-4">ã‚ãªãŸã®è² æ‹…ã®å†…è¨³</h4>
                        <div class="h-64"><canvas id="burden-chart"></canvas></div>
                    </div>
                    <div class="result-card bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold text-slate-600">è² æ‹…é¡ã®ä½¿ã‚ã‚Œæ–¹</h4>
                             <a href="spending-details.html" class="text-sm text-indigo-600 hover:underline">è©³ã—ãã¯ã“ã¡ã‚‰ &rarr;</a>
                        </div>
                        <div class="h-64"><canvas id="spending-chart"></canvas></div>
                    </div>
                </div>
                
                <!-- Calculation Basis -->
                <div class="result-card bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <details>
                        <summary class="text-lg font-semibold text-slate-700 cursor-pointer list-none">
                            è¨ˆç®—ã®å‰æã¨å‡ºå…¸ã¯ã“ã¡ã‚‰
                        </summary>
                        <div id="basis-text-container" class="mt-4 text-sm text-slate-600 space-y-4 prose prose-sm max-w-none">
                             <!-- Populated by JS -->
                        </div>
                    </details>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Chart instances
        let burdenChart = null;
        let spendingChart = null;

        // DOM Elements
        const calculateBtn = document.getElementById('calculate-btn');
        const resultContainer = document.getElementById('result-container');
        
        const annualIncomeInput = document.getElementById('annual-income');
        const ageInput = document.getElementById('age');
        const prefectureSelect = document.getElementById('prefecture');
        const workTypeSelect = document.getElementById('work-type');
        const dependentsHsSelect = document.getElementById('dependents-hs');
        const dependentsJhsSelect = document.getElementById('dependents-jhs');
        const dependentsSpecificSelect = document.getElementById('dependents-specific');
        const dependentsElderlySelect = document.getElementById('dependents-elderly');
        const spouseSelect = document.getElementById('spouse');
        const homeOwnershipSelect = document.getElementById('home-ownership');
        const carOwnershipSelect = document.getElementById('car-ownership');
        const smokingHabitSelect = document.getElementById('smoking-habit');
        const drinkingHabitSelect = document.getElementById('drinking-habit');
        const golfHabitSelect = document.getElementById('golf-habit');
        const pensionInputContainer = document.getElementById('pension-input-container');
        const isPensionRecipientSelect = document.getElementById('is-pension-recipient');

        // Result Elements
        const netIncomeEl = document.getElementById('net-income');
        const netContributionEl = document.getElementById('net-contribution');
        const netContributionDetailEl = document.getElementById('net-contribution-detail');
        const burdenBreakdownSummaryEl = document.getElementById('burden-breakdown-summary');
        const summaryBenefitEl = document.querySelector('#summary-benefit span');
        const benefitBreakdownEl = document.getElementById('benefit-breakdown');
        const basisTextContainer = document.getElementById('basis-text-container');

        // --- Constants and Data (2025å¹´åº¦ãƒ™ãƒ¼ã‚¹ã®æ¦‚ç®—å€¤) ---
        const DATA = {
            incomeTaxRates: [
                { limit: 1950000, rate: 0.05 }, { limit: 3300000, rate: 0.10 },
                { limit: 6950000, rate: 0.20 }, { limit: 9000000, rate: 0.23 },
                { limit: 18000000, rate: 0.33 }, { limit: 40000000, rate: 0.40 },
                { limit: Infinity, rate: 0.45 },
            ],
            residenceTaxRate: 0.10,
            residenceTaxFlat: 5000,
            healthInsuranceRates: { // Note: 2025å¹´åº¦ã®æ–™ç‡ã¯æœ€æ–°ã®ç™ºè¡¨ã‚’ã”ç¢ºèªãã ã•ã„ã€‚ã“ã“ã§ã¯2024å¹´åº¦ã®å€¤ã‚’å‚ç…§ã—ã¦ã„ã¾ã™ã€‚
                hokkaido: { base: 0.1013, kaigo: 0.1175 }, aomori: { base: 0.0967, kaigo: 0.1129 },
                iwate: { base: 0.0955, kaigo: 0.1117 }, miyagi: { base: 0.0991, kaigo: 0.1153 },
                akita: { base: 0.0964, kaigo: 0.1126 }, yamagata: { base: 0.0978, kaigo: 0.1140 },
                fukushima: { base: 0.0964, kaigo: 0.1126 }, ibaraki: { base: 0.0980, kaigo: 0.1142 },
                tochigi: { base: 0.0985, kaigo: 0.1147 }, gunma: { base: 0.0988, kaigo: 0.1150 },
                saitama: { base: 0.0985, kaigo: 0.1147 }, chiba: { base: 0.0986, kaigo: 0.1148 },
                tokyo: { base: 0.1000, kaigo: 0.1162 }, kanagawa: { base: 0.1002, kaigo: 0.1164 },
                niigata: { base: 0.0952, kaigo: 0.1114 }, toyama: { base: 0.0962, kaigo: 0.1124 },
                ishikawa: { base: 0.0985, kaigo: 0.1147 }, fukui: { base: 0.0991, kaigo: 0.1153 },
                yamanashi: { base: 0.0988, kaigo: 0.1150 }, nagano: { base: 0.0972, kaigo: 0.1134 },
                gifu: { base: 0.0990, kaigo: 0.1152 }, shizuoka: { base: 0.0982, kaigo: 0.1144 },
                aichi: { base: 0.0996, kaigo: 0.1158 }, mie: { base: 0.0996, kaigo: 0.1158 },
                shiga: { base: 0.1003, kaigo: 0.1165 }, kyoto: { base: 0.1007, kaigo: 0.1169 },
                osaka: { base: 0.1034, kaigo: 0.1196 }, hyogo: { base: 0.1021, kaigo: 0.1183 },
                nara: { base: 0.1012, kaigo: 0.1174 }, wakayama: { base: 0.1009, kaigo: 0.1171 },
                tottori: { base: 0.0985, kaigo: 0.1147 }, shimane: { base: 0.0994, kaigo: 0.1156 },
                okayama: { base: 0.1005, kaigo: 0.1167 }, hiroshima: { base: 0.1003, kaigo: 0.1165 },
                yamaguchi: { base: 0.1017, kaigo: 0.1179 }, tokushima: { base: 0.1022, kaigo: 0.1184 },
                kagawa: { base: 0.1025, kaigo: 0.1187 }, ehime: { base: 0.1008, kaigo: 0.1170 },
                kochi: { base: 0.1009, kaigo: 0.1171 }, fukuoka: { base: 0.1045, kaigo: 0.1207 },
                saga: { base: 0.1051, kaigo: 0.1213 }, nagasaki: { base: 0.1028, kaigo: 0.1190 },
                kumamoto: { base: 0.1030, kaigo: 0.1192 }, oita: { base: 0.1017, kaigo: 0.1179 },
                miyazaki: { base: 0.0999, kaigo: 0.1161 }, kagoshima: { base: 0.1019, kaigo: 0.1181 },
                okinawa: { base: 0.0955, kaigo: 0.1117 }
            },
            pensionInsuranceRate: 0.183, // 2017å¹´ä»¥é™18.3%ã§å›ºå®š
            employmentInsuranceRate: 0.0155, // 2024å¹´åº¦ã®æ–™ç‡ã€‚å¹´åº¦ã«ã‚ˆã‚Šå¤‰å‹•
            nationalPensionPerMonth: 17510, // 2025å¹´åº¦
            medicalBenefitByAge: {
                20: 80000, 30: 100000, 40: 150000, 50: 250000, 60: 400000, 70: 600000
            },
            consumptionDataPoints: [
                { income: 0, expenditure: 0 },
                { income: 300, expenditure: 225 },
                { income: 500, expenditure: 325 },
                { income: 800, expenditure: 440 },
                { income: 1200, expenditure: 540 },
                { income: 2000, expenditure: 700 },
                { income: 5000, expenditure: 1250 },
                { income: 10000, expenditure: 2000 }
            ],
            nationalSpendingRatio: { // 2024å¹´åº¦ä¸€èˆ¬ä¼šè¨ˆæ­³å‡ºäºˆç®—ãƒ™ãƒ¼ã‚¹
                'ç¤¾ä¼šä¿éšœ': 0.33, 'å›½å‚µè²»': 0.24, 'åœ°æ–¹äº¤ä»˜ç¨': 0.14,
                'å…¬å…±äº‹æ¥­': 0.06, 'æ•™è‚²ãƒ»ç§‘å­¦': 0.05, 'é˜²è¡›': 0.07, 'ãã®ä»–': 0.11,
            },
            indirectTaxEstimates: {
                home: { owned_low: 80000, owned_high: 250000 },
                car: { light: 30000, normal: 60000 },
                smoking: { sometimes: 40000, daily: 150000 },
                drinking: { sometimes: 20000, often: 60000 },
                golf: { sometimes: 8000, often: 24000 }
            },
            averagePensionBenefit: 1800000,
        };
        const PREFECTURES = {
            hokkaido: 'åŒ—æµ·é“', aomori: 'é’æ£®çœŒ', iwate: 'å²©æ‰‹çœŒ', miyagi: 'å®®åŸçœŒ', akita: 'ç§‹ç”°çœŒ', yamagata: 'å±±å½¢çœŒ',
            fukushima: 'ç¦å³¶çœŒ', ibaraki: 'èŒ¨åŸçœŒ', tochigi: 'æ ƒæœ¨çœŒ', gunma: 'ç¾¤é¦¬çœŒ', saitama: 'åŸ¼ç‰çœŒ', chiba: 'åƒè‘‰çœŒ',
            tokyo: 'æ±äº¬éƒ½', kanagawa: 'ç¥å¥ˆå·çœŒ', niigata: 'æ–°æ½ŸçœŒ', toyama: 'å¯Œå±±çœŒ', ishikawa: 'çŸ³å·çœŒ', fukui: 'ç¦äº•çœŒ',
            yamanashi: 'å±±æ¢¨çœŒ', nagano: 'é•·é‡çœŒ', gifu: 'å²é˜œçœŒ', shizuoka: 'é™å²¡çœŒ', aichi: 'æ„›çŸ¥çœŒ', mie: 'ä¸‰é‡çœŒ',
            shiga: 'æ»‹è³€çœŒ', kyoto: 'äº¬éƒ½åºœ', osaka: 'å¤§é˜ªåºœ', hyogo: 'å…µåº«çœŒ', nara: 'å¥ˆè‰¯çœŒ', wakayama: 'å’Œæ­Œå±±çœŒ',
            tottori: 'é³¥å–çœŒ', shimane: 'å³¶æ ¹çœŒ', okayama: 'å²¡å±±çœŒ', hiroshima: 'åºƒå³¶çœŒ', yamaguchi: 'å±±å£çœŒ',
            tokushima: 'å¾³å³¶çœŒ', kagawa: 'é¦™å·çœŒ', ehime: 'æ„›åª›çœŒ', kochi: 'é«˜çŸ¥çœŒ', fukuoka: 'ç¦å²¡çœŒ', saga: 'ä½è³€çœŒ',
            nagasaki: 'é•·å´çœŒ', kumamoto: 'ç†Šæœ¬çœŒ', oita: 'å¤§åˆ†çœŒ', miyazaki: 'å®®å´çœŒ', kagoshima: 'é¹¿å…å³¶çœŒ', okinawa: 'æ²–ç¸„çœŒ'
        };

        // --- Initial Setup ---
        function populatePrefectures() {
            for (const [key, name] of Object.entries(PREFECTURES)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = name;
                if (key === 'tokyo') {
                    option.selected = true;
                }
                prefectureSelect.appendChild(option);
            }
        }

        function handleAgeChange() {
            const age = parseInt(ageInput.value);
            if (age >= 65) {
                pensionInputContainer.classList.remove('hidden');
                isPensionRecipientSelect.value = 'yes';
            } else {
                pensionInputContainer.classList.add('hidden');
                isPensionRecipientSelect.value = 'no';
            }
        }

        // --- Calculation Logic ---
        function calculate() {
            // 1. Get user inputs
            const incomeValue = annualIncomeInput.value.replace(/,/g, '');
            const income = parseFloat(incomeValue) * 10000;
            const age = parseInt(ageInput.value);
            if (isNaN(income) || income < 0 || isNaN(age) || age <= 0) {
                console.error('å¹´åã¨å¹´é½¢ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const prefectureKey = prefectureSelect.value;
            const workType = workTypeSelect.value;
            const dependentsHsCount = parseInt(dependentsHsSelect.value);
            const dependentsJhsCount = parseInt(dependentsJhsSelect.value);
            const dependentsSpecificCount = parseInt(dependentsSpecificSelect.value);
            const dependentsElderlyCount = parseInt(dependentsElderlySelect.value);
            const spouseType = spouseSelect.value;
            const isPensionRecipient = isPensionRecipientSelect.value === 'yes';
            
            // 2. Initialize variables
            let incomeTax = 0, residenceTax = 0, socialInsurance = 0, consumptionTax = 0;
            let healthInsurance = 0, pension = 0, employmentInsurance = 0, longTermCareInsurance = 0;

            // 3. Calculate deductions
            let salaryDeduction = 0;
            if (workType === 'company-employee') {
                if (income <= 1625000) salaryDeduction = 550000;
                else if (income <= 1800000) salaryDeduction = income * 0.4 - 100000;
                else if (income <= 3600000) salaryDeduction = income * 0.3 + 80000;
                else if (income <= 6600000) salaryDeduction = income * 0.2 + 440000;
                else if (income <= 8500000) salaryDeduction = income * 0.1 + 1100000;
                else salaryDeduction = 1950000;
            }

            // 4. Calculate social insurance
            if (income > 0) {
                if (workType === 'company-employee') {
                    const isKaigoAge = age >= 40 && age < 65;
                    const standardMonthlyIncome = Math.min(Math.round(income / 12 / 10000) * 10000, 1390000);
                    const standardBonus = Math.min(Math.max(0, income - standardMonthlyIncome * 12), 5730000);
                    const totalStandardIncome = standardMonthlyIncome * 12 + standardBonus;

                    const rates = DATA.healthInsuranceRates[prefectureKey];
                    const healthRate = isKaigoAge ? rates.kaigo : rates.base;
                    
                    const totalHealthInsurance = totalStandardIncome * healthRate / 2;
                    if(isKaigoAge) {
                        const kaigoRateOnly = rates.kaigo - rates.base;
                        longTermCareInsurance = totalStandardIncome * kaigoRateOnly / 2;
                        healthInsurance = totalHealthInsurance - longTermCareInsurance;
                    } else {
                        healthInsurance = totalHealthInsurance;
                    }
                    pension = Math.min(income, 7980000) * DATA.pensionInsuranceRate / 2;
                    employmentInsurance = income * 0.006;
                    socialInsurance = healthInsurance + longTermCareInsurance + pension + employmentInsurance;
                } else { // Freelancer
                    const taxableIncomeForNHI = Math.max(0, income - 480000 - 650000);
                    healthInsurance = Math.min(taxableIncomeForNHI * 0.1, 1060000);
                    pension = DATA.nationalPensionPerMonth * 12;
                    socialInsurance = healthInsurance + pension;
                }
            }
            
            // 5. Calculate taxes with precise deductions
            const socialInsuranceDeduction = socialInsurance;

            // For Income Tax
            const basicDeductionIT = income <= 24000000 ? 480000 : (income <= 24500000 ? 320000 : (income <= 25000000 ? 160000 : 0));
            const spouseDeductionIT = (spouseType === 'dependent' && income <= 11950000) ? 380000 : 0;
            const dependentDeductionIT = (dependentsHsCount * 380000) + (dependentsSpecificCount * 630000) + (dependentsElderlyCount * 480000); // 70æ­³ä»¥ä¸Šã¯åˆ¥å±…ã‚’æƒ³å®š
            const taxableIncomeIT = Math.max(0, income - salaryDeduction - socialInsuranceDeduction - basicDeductionIT - spouseDeductionIT - dependentDeductionIT);

            // For Residence Tax
            const basicDeductionRT = income <= 24000000 ? 430000 : 0; // Simplified
            const spouseDeductionRT = (spouseType === 'dependent' && income <= 11950000) ? 330000 : 0; // Simplified
            const dependentDeductionRT = (dependentsHsCount * 330000) + (dependentsSpecificCount * 450000) + (dependentsElderlyCount * 380000); // 70æ­³ä»¥ä¸Šã¯åˆ¥å±…ã‚’æƒ³å®š
            const taxableIncomeRT = Math.max(0, income - salaryDeduction - socialInsuranceDeduction - basicDeductionRT - spouseDeductionRT - dependentDeductionRT);

            if (taxableIncomeIT > 0) {
                let tempTaxable = taxableIncomeIT;
                let prevLimit = 0;
                incomeTax = 0;
                for (const tier of DATA.incomeTaxRates) {
                    if (tempTaxable <= 0) break;
                    const taxableInTier = Math.min(tempTaxable, tier.limit - prevLimit);
                    incomeTax += taxableInTier * tier.rate;
                    tempTaxable -= taxableInTier;
                    prevLimit = tier.limit;
                }
                incomeTax *= 1.021;
            }
            residenceTax = (taxableIncomeRT > 0) ? (taxableIncomeRT * DATA.residenceTaxRate + DATA.residenceTaxFlat) : ((income > 0) ? DATA.residenceTaxFlat : 0);

            // 6. Calculate other taxes
            const incomeInMan = income / 10000;
            let consumptionExpenditure = 0;
            if (incomeInMan > 0) {
                let lowerBound = DATA.consumptionDataPoints[0];
                let upperBound = DATA.consumptionDataPoints[DATA.consumptionDataPoints.length - 1];

                for (let i = 1; i < DATA.consumptionDataPoints.length; i++) {
                    if (incomeInMan <= DATA.consumptionDataPoints[i].income) {
                        upperBound = DATA.consumptionDataPoints[i];
                        lowerBound = DATA.consumptionDataPoints[i-1];
                        break;
                    }
                }
                
                const incomeRange = upperBound.income - lowerBound.income;
                const expenditureRange = upperBound.expenditure - lowerBound.expenditure;
                
                if (incomeRange > 0) {
                    const ratio = (incomeInMan - lowerBound.income) / incomeRange;
                    consumptionExpenditure = (lowerBound.expenditure + (expenditureRange * ratio)) * 10000;
                } else { 
                    const lastPoint = DATA.consumptionDataPoints[DATA.consumptionDataPoints.length - 1];
                    const secondLastPoint = DATA.consumptionDataPoints[DATA.consumptionDataPoints.length - 2];
                    const lastRate = (lastPoint.expenditure - secondLastPoint.expenditure) / (lastPoint.income - secondLastPoint.income);
                    consumptionExpenditure = (lastPoint.expenditure + (incomeInMan - lastPoint.income) * lastRate) * 10000;
                }
            }
            consumptionTax = consumptionExpenditure * (10 / 110);

            let otherIndirectTaxes = 0;
            const homeChoice = homeOwnershipSelect.value;
            if (homeChoice !== 'none') otherIndirectTaxes += DATA.indirectTaxEstimates.home[homeChoice];
            const carChoice = carOwnershipSelect.value;
            if (carChoice !== 'none') otherIndirectTaxes += DATA.indirectTaxEstimates.car[carChoice];
            const smokingChoice = smokingHabitSelect.value;
            if (smokingChoice !== 'none') otherIndirectTaxes += DATA.indirectTaxEstimates.smoking[smokingChoice];
            const drinkingChoice = drinkingHabitSelect.value;
            if (drinkingChoice !== 'none') otherIndirectTaxes += DATA.indirectTaxEstimates.drinking[drinkingChoice];
            const golfChoice = golfHabitSelect.value;
            if (golfChoice !== 'none') otherIndirectTaxes += DATA.indirectTaxEstimates.golf[golfChoice];
            
            // 7. Calculate benefits
            const ageBracket = Math.floor(age / 10) * 10;
            const medicalBenefit = DATA.medicalBenefitByAge[ageBracket] || DATA.medicalBenefitByAge[70];
            
            const allChildrenCount = dependentsJhsCount + dependentsHsCount;
            let childBenefit = 0;
            if (allChildrenCount === 1) childBenefit = 120000;
            else if (allChildrenCount === 2) childBenefit = 120000 * 2;
            else if (allChildrenCount >= 3) childBenefit = (120000 * 2) + (360000 * (allChildrenCount - 2));

            let pensionBenefit = 0;
            if (age >= 65 && isPensionRecipient) {
                pensionBenefit = DATA.averagePensionBenefit;
            }
            const publicBenefit = medicalBenefit + childBenefit + pensionBenefit;

            // 8. Final calculations
            const totalBurden = incomeTax + residenceTax + socialInsurance + consumptionTax + otherIndirectTaxes;
            const netIncome = income - (incomeTax + residenceTax + socialInsurance);
            const netContribution = totalBurden - publicBenefit;
            
            // 9. Update UI
            updateUI({
                netIncome, totalBurden, publicBenefit, netContribution,
                burdens: {
                    'æ‰€å¾—ç¨': incomeTax, 'ä½æ°‘ç¨': residenceTax, 'å¹´é‡‘ä¿é™ºæ–™': pension,
                    'å¥åº·ãƒ»ä»‹è­·ä¿é™ºæ–™': healthInsurance + longTermCareInsurance,
                    'é›‡ç”¨ä¿é™ºæ–™': employmentInsurance, 'æ¶ˆè²»ç¨(æ¨è¨ˆ)': consumptionTax, 'ãã®ä»–è«¸ç¨(æ¨è¨ˆ)': otherIndirectTaxes,
                },
                benefits: {
                    'åŒ»ç™‚è²»è£œåŠ©(å¹´ä»£å¹³å‡)': medicalBenefit, 'å…ç«¥æ‰‹å½“': childBenefit, 'å¹´é‡‘çµ¦ä»˜': pensionBenefit
                },
                details: {
                    consumptionExpenditure,
                    ageBracket,
                    medicalBenefit,
                }
            });
        }

        // --- UI Update Logic ---
        function updateUI(results) {
            const formatYen = (val, unit = 'ä¸‡å††') => `${new Intl.NumberFormat('ja-JP').format(Math.round(val / 10000))}${unit}`;
            
            netIncomeEl.textContent = formatYen(results.netIncome);
            
            const directTaxes = results.burdens['æ‰€å¾—ç¨'] + results.burdens['ä½æ°‘ç¨'];
            const directInsurance = results.burdens['å¹´é‡‘ä¿é™ºæ–™'] + results.burdens['å¥åº·ãƒ»ä»‹è­·ä¿é™ºæ–™'] + results.burdens['é›‡ç”¨ä¿é™ºæ–™'];
            const consumptionBurden = results.burdens['æ¶ˆè²»ç¨(æ¨è¨ˆ)'] + results.burdens['ãã®ä»–è«¸ç¨(æ¨è¨ˆ)'];

            burdenBreakdownSummaryEl.innerHTML = `
                <div class="flex justify-between items-baseline">
                    <span>ç¨é‡‘:</span>
                    <span class="text-xl font-bold">${formatYen(directTaxes)}</span>
                </div>
                <div class="flex justify-between items-baseline mt-1">
                    <span>ç¤¾ä¼šä¿é™ºæ–™:</span>
                    <span class="text-xl font-bold">${formatYen(directInsurance)}</span>
                </div>
                <hr class="my-2 border-red-200">
                <div class="flex justify-between items-baseline font-bold">
                    <span>æ§é™¤åˆè¨ˆ:</span>
                    <span class="text-2xl">${formatYen(directTaxes + directInsurance)}</span>
                </div>
            `;

            summaryBenefitEl.textContent = formatYen(results.publicBenefit);
            netContributionEl.textContent = formatYen(results.netContribution);
            netContributionDetailEl.textContent = `ï¼ˆæ‰€å¾—ã‹ã‚‰ã®æ§é™¤ ${formatYen(directTaxes + directInsurance)} + æ¶ˆè²»ç¨ãªã© ${formatYen(consumptionBurden)} - å…¬çš„ã‚µãƒãƒ¼ãƒˆ ${formatYen(results.publicBenefit)}ï¼‰`;
            netContributionEl.className = `text-4xl font-extrabold ${results.netContribution >= 0 ? 'text-slate-700' : 'text-red-500'}`;
            
            benefitBreakdownEl.innerHTML = '';
            for (const [key, value] of Object.entries(results.benefits)) {
                if (value > 0) {
                    const p = document.createElement('p');
                    p.className = 'text-sm text-blue-700 ml-4';
                    p.textContent = `- ${key}: ${formatYen(value)}`;
                    benefitBreakdownEl.appendChild(p);
                }
            }

            populateBasisText(results);
            updateBurdenChart(results.burdens);
            updateSpendingChart(results.totalBurden);
            
            resultContainer.classList.add('visible');
        }

        function populateBasisText(results) {
            const formatYenFull = (val) => new Intl.NumberFormat('ja-JP').format(Math.round(val)) + 'å††';
            
            let burdenHtml = `
                <li><strong>æ‰€å¾—ç¨ãƒ»ä½æ°‘ç¨:</strong> åŸºç¤æ§é™¤ã€çµ¦ä¸æ‰€å¾—æ§é™¤ï¼ˆä¼šç¤¾å“¡ã®å ´åˆï¼‰ã€ç¤¾ä¼šä¿é™ºæ–™æ§é™¤ã€é…å¶è€…æ§é™¤ã€æ‰¶é¤Šæ§é™¤ã‚’è€ƒæ…®ã—ã¦èª²ç¨æ‰€å¾—ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚æ‰€å¾—ç¨ã¨ä½æ°‘ç¨ã§ã¯å„æ§é™¤é¡ãŒç•°ãªã‚‹ãŸã‚ã€ãã‚Œãã‚Œåˆ¥ã«è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚æ‰¶é¤Šæ§é™¤ã¯ã€é«˜æ ¡ç”Ÿã®å¹´ä»£ã®å­ã©ã‚‚ï¼ˆä¸€èˆ¬æ‰¶é¤Šè¦ªæ—ï¼‰ã€19æ­³ã€œ69æ­³ã®è¦ªæ—ï¼ˆç‰¹å®šæ‰¶é¤Šè¦ªæ—ï¼‰ã€70æ­³ä»¥ä¸Šã®è¦ªæ—ï¼ˆè€äººæ‰¶é¤Šè¦ªæ—ãƒ»åˆ¥å±…ã‚’æƒ³å®šï¼‰ã‚’å¯¾è±¡ã¨ã—ã¦ã„ã¾ã™ã€‚ç”Ÿå‘½ä¿é™ºæ–™æ§é™¤ã‚„åŒ»ç™‚è²»æ§é™¤ãªã©ã€ãã®ä»–ã®å€‹äººçš„ãªæ§é™¤ã¯å«ã‚“ã§ã„ã¾ã›ã‚“ã€‚</li>
                <li><strong>ç¤¾ä¼šä¿é™ºæ–™:</strong> ã€Œä¼šç¤¾å“¡ã€ã¯å¥åº·ä¿é™ºãƒ»åšç”Ÿå¹´é‡‘ã€ã€Œè‡ªå–¶æ¥­ã€ã¯å›½æ°‘å¥åº·ä¿é™ºãƒ»å›½æ°‘å¹´é‡‘ã‚’æƒ³å®šã€‚æ–™ç‡ã¯é¸æŠã•ã‚ŒãŸéƒ½é“åºœçœŒã¨å¹´é½¢ã«åŸºã¥ãã€40æ­³ä»¥ä¸Šã¯ä»‹è­·ä¿é™ºæ–™ãŒåŠ ç®—ã•ã‚Œã¾ã™ã€‚</li>
                <li><strong>æ¶ˆè²»ç¨(æ¨è¨ˆ):</strong> å¹´åã¨å¹´é½¢ã‹ã‚‰å¹³å‡çš„ãªæ¶ˆè²»æ”¯å‡ºï¼ˆä»Šå›ã®å ´åˆã€å¹´é–“ <strong>${formatYenFull(results.details.consumptionExpenditure)}</strong>ï¼‰ã‚’ã€Œå®¶è¨ˆèª¿æŸ»ï¼ˆç·å‹™çœçµ±è¨ˆå±€ï¼‰ã€ã‚’å‚è€ƒã«æ¨è¨ˆã—ã€ç¨ç‡10%ã§ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚</li>
            `;

            let otherTaxesHtml = '<li><strong>ãã®ä»–è«¸ç¨(æ¨è¨ˆ):</strong> ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ã®é¸æŠã«å¿œã˜ã¦ä¸‹è¨˜ã®ç¨é¡ã‚’æ¦‚ç®—ã§åŠ ç®—ã—ã¦ã„ã¾ã™ã€‚<ul>';
            let hasOtherTaxes = false;

            const homeChoice = homeOwnershipSelect.value;
            if (homeChoice !== 'none') { hasOtherTaxes = true; otherTaxesHtml += `<li>å›ºå®šè³‡ç”£ç¨ãªã©: æŒã¡å®¶ã®è©•ä¾¡é¡ã«å¿œã˜ãŸæ¨™æº–ç¨ç‡ï¼ˆ1.4%ï¼‰ã‚’ä»®å®šã€‚</li>`; }
            const carChoice = carOwnershipSelect.value;
            if (carChoice !== 'none') { hasOtherTaxes = true; otherTaxesHtml += `<li>è‡ªå‹•è»Šé–¢é€£ç¨: ${carChoice === 'light' ? 'è»½è‡ªå‹•è»Š' : 'æ™®é€šè‡ªå‹•è»Š'}ã®è‡ªå‹•è»Šç¨ãƒ»é‡é‡ç¨ãªã©ã‚’æƒ³å®šã€‚</li>`; }
            const smokingChoice = smokingHabitSelect.value;
            if (smokingChoice !== 'none') { hasOtherTaxes = true; otherTaxesHtml += `<li>ãŸã°ã“ç¨: ${smokingChoice === 'daily' ? '1æ—¥1ç®±' : 'é€±ã«æ•°æœ¬'}ã®æ¶ˆè²»ã‚’ä»®å®šã€‚</li>`; }
            const drinkingChoice = drinkingHabitSelect.value;
            if (drinkingChoice !== 'none') { hasOtherTaxes = true; otherTaxesHtml += `<li>é…’ç¨: ${drinkingChoice === 'often' ? 'ãƒ“ãƒ¼ãƒ«é¡ã‚’é€±3æ—¥' : 'é€±1æ—¥'}ç¨‹åº¦é£²ã‚€ã¨ä»®å®šã€‚</li>`; }
            const golfChoice = golfHabitSelect.value;
            if (golfChoice !== 'none') { hasOtherTaxes = true; otherTaxesHtml += `<li>ã‚´ãƒ«ãƒ•å ´åˆ©ç”¨ç¨: ${golfChoice === 'often' ? 'å¹´é–“30å›' : 'å¹´é–“10å›'}ç¨‹åº¦ã®åˆ©ç”¨ã‚’ä»®å®šï¼ˆ1å›800å††ï¼‰ã€‚</li>`; }
            
            if (hasOtherTaxes) { burdenHtml += otherTaxesHtml + '</ul></li>'; }

            burdenHtml += `<li>â€»ä½æ°‘ç¨ã®ã€Œå‡ç­‰å‰²ã€ã‚„ã€è‡ªå–¶æ¥­è€…ã®ã€Œå›½æ°‘å¹´é‡‘ä¿é™ºæ–™ã€ã¯æ‰€å¾—ãŒä½ã„å ´åˆã§ã‚‚å®šé¡ã§ç™ºç”Ÿã™ã‚‹ãŸã‚ã€å¹´åãŒä½ãã¦ã‚‚è² æ‹…é¡ãŒ0å††ã«ãªã‚‰ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼ˆè‡ªæ²»ä½“ã«ã‚ˆã‚‹æ¸›å…æªç½®ã¯æœªå¯¾å¿œï¼‰ã€‚</li>`;


            let benefitHtml = `
                <li><strong>åŒ»ç™‚è²»è£œåŠ©:</strong> ã‚ãªãŸã®å¹´é½¢ï¼ˆ${results.details.ageBracket}ä»£ï¼‰ã®1äººã‚ãŸã‚Šå¹´é–“å¹³å‡åŒ»ç™‚è²»ï¼ˆç´„${formatYenFull(results.details.medicalBenefit / 0.7)}ï¼‰ã‹ã‚‰ã€è‡ªå·±è² æ‹…åˆ†ã‚’å¼•ã„ãŸå®Ÿè³ªçš„ãªå…¬è²»è² æ‹…é¡ã‚’æ¨è¨ˆã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ç›´æ¥çš„ãªç¾é‡‘çµ¦ä»˜ã§ã¯ãªãã€åŒ»ç™‚ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨æ™‚ã®è²»ç”¨è»½æ¸›ã¨ã„ã†å½¢ã§ã®ã‚µãƒãƒ¼ãƒˆã§ã™ã€‚</li>
                <li><strong>å…ç«¥æ‰‹å½“:</strong> 2024å¹´10æœˆã‹ã‚‰æ‹¡å……ã•ã‚ŒãŸåˆ¶åº¦ã«åŸºã¥ãè¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚æ‰€å¾—åˆ¶é™ã¯ãªãã€é«˜æ ¡ç”Ÿã®å¹´ä»£ã¾ã§ãŒå¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚ç¬¬3å­ä»¥é™ã¯æœˆé¡3ä¸‡å††ã§è¨ˆç®—ã—ã¦ã„ã¾ã™ï¼ˆå­ã®å¹´é½¢ã«ã‚ˆã‚‹è©³ç´°ãªé‡‘é¡å·®ã¯ç°¡ç•¥åŒ–ï¼‰ã€‚</li>
            `;
            if (results.benefits['å¹´é‡‘çµ¦ä»˜'] > 0) {
                benefitHtml += `<li><strong>å¹´é‡‘çµ¦ä»˜:</strong> 65æ­³ä»¥ä¸Šã§ã€Œã¯ã„ã€ã‚’é¸æŠã—ãŸå ´åˆã€å›½æ°‘å¹´é‡‘ãƒ»åšç”Ÿå¹´é‡‘ã‚’åˆç®—ã—ãŸå¹³å‡çš„ãªå—çµ¦é¡ï¼ˆå¹´é¡ç´„${formatYenFull(DATA.averagePensionBenefit)}ï¼‰ã‚’çµ¦ä»˜ã«åŠ ãˆã¦ã„ã¾ã™ã€‚</li>`;
            }
            benefitHtml += `<li>â€»ä¸Šè¨˜ã¯ä»£è¡¨ä¾‹ã§ã™ã€‚å®Ÿéš›ã®ã‚µãƒãƒ¼ãƒˆã¯ã€å¤±æ¥­ã€éšœå®³ã€ä½æ‰€å¾—ãªã©å€‹åˆ¥ã®çŠ¶æ³ã«å¿œã˜ã¦å¤šå²ã«ã‚ãŸã‚Šã¾ã™ãŒã€æœ¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ç°¡ç•¥åŒ–ã—ã¦ã„ã¾ã™ã€‚</li>`;

            basisTextContainer.innerHTML = `
                <p>ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€å…¬é–‹ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã«åŸºã¥ãã€ã„ãã¤ã‹ã®ä»®å®šã‚’ç½®ã„ã¦è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚ã‚ãªãŸã®ç”Ÿæ´»ã‚’ã‚ˆã‚Šè‰¯ãã™ã‚‹ãŸã‚ã®ã€ã‚ãã¾ã§ã€Œè€ƒãˆã‚‹ãã£ã‹ã‘ã€ã¨ã—ã¦ã”æ´»ç”¨ãã ã•ã„ã€‚ï¼ˆ2025å¹´åº¦ã®åˆ¶åº¦ãƒ»2024å¹´åº¦ã®äºˆç®—ã«åŸºã¥ãï¼‰</p>
                <div class="p-4 bg-slate-50 rounded-lg">
                    <h5 class="font-bold text-slate-700">è² æ‹…ï¼ˆç¨é‡‘ãƒ»ç¤¾ä¼šä¿é™ºæ–™ï¼‰ã®è¨ˆç®—ã«ã¤ã„ã¦</h5>
                    <ul class="mt-2 space-y-3">${burdenHtml}</ul>
                </div>
                <div class="p-4 bg-slate-50 rounded-lg">
                    <h5 class="font-bold text-slate-700">å…¬çš„ã‚µãƒãƒ¼ãƒˆã®è¨ˆç®—ã«ã¤ã„ã¦</h5>
                    <ul class="mt-2 space-y-3">${benefitHtml}</ul>
                </div>
                 <div class="p-4 bg-slate-50 rounded-lg">
                    <h5 class="font-bold text-slate-700">ã€Œè² æ‹…é¡ã®ä½¿ã‚ã‚Œæ–¹ã€ã‚°ãƒ©ãƒ•ã«ã¤ã„ã¦</h5>
                    <p class="mt-2 text-xs md:text-sm">ã“ã®ã‚°ãƒ©ãƒ•ã¯ã€ã‚ãªãŸã®ç·è² æ‹…é¡ãŒã€å›½ã®ä¸€èˆ¬ä¼šè¨ˆæ­³å‡ºäºˆç®—ï¼ˆ2024å¹´åº¦ï¼‰ã®å‰²åˆã«å¿œã˜ã¦ã€ã©ã®åˆ†é‡ã«é…åˆ†ã•ã‚Œã‚‹ã‹ã‚’è¦–è¦šåŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚</p>
                </div>
                <div class="p-4 bg-slate-50 rounded-lg">
                    <h5 class="font-bold text-slate-700">å‡ºå…¸æƒ…å ±</h5>
                    <ul class="mt-2 space-y-3">
                        <li><a href="https://www.nta.go.jp/" target="_blank" class="text-indigo-600 hover:underline">å›½ç¨åº</a> (æ‰€å¾—ç¨)</li>
                        <li><a href="https://www.kyoukaikenpo.or.jp/" target="_blank" class="text-indigo-600 hover:underline">å…¨å›½å¥åº·ä¿é™ºå”ä¼š</a> (å¥åº·ä¿é™ºæ–™ç‡)</li>
                        <li><a href="https://www.mhlw.go.jp/" target="_blank" class="text-indigo-600 hover:underline">åšç”ŸåŠ´åƒçœ</a> (ç¤¾ä¼šä¿é™ºæ–™ã€åŒ»ç™‚è²»ã€å¹´é‡‘)</li>
                        <li><a href="https://www.mof.go.jp/policy/budget/budger_workflow/budget/index.html" target="_blank" class="text-indigo-600 hover:underline">è²¡å‹™çœ</a> (å›½ã®äºˆç®—)</li>
                        <li><a href="https://www.stat.go.jp/data/kakei/index.html" target="_blank" class="text-indigo-600 hover:underline">ç·å‹™çœçµ±è¨ˆå±€</a> (å®¶è¨ˆèª¿æŸ»)</li>
                    </ul>
                </div>
            `;
        }

        // Chart.js Datalabels Pluginã®ç™»éŒ²
        Chart.register(ChartDataLabels);

        function updateBurdenChart(burdens) {
            const ctx = document.getElementById('burden-chart').getContext('2d');
            const labels = Object.keys(burdens).filter(k => burdens[k] > 0.1);
            const data = labels.map(l => burdens[l]);

            if (burdenChart) burdenChart.destroy();
            burdenChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#4f46e5', '#6366f1', '#34d399', '#6ee7b7', '#a5b4fc', '#fbbf24', '#f59e0b'],
                        borderColor: '#fff', borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 12 }, padding: 15 }},
                        tooltip: { 
                            callbacks: { 
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed;
                                    const sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / sum) * 100).toFixed(1) + '%';
                                    label += new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value);
                                    label += ` (${percentage})`;
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum);
                                if (percentage < 5) return '';
                                return `${Math.round(value/10000)}ä¸‡å††`;
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 10, }
                        }
                    }
                }
            });
        }

        function updateSpendingChart(totalBurden) {
            const ctx = document.getElementById('spending-chart').getContext('2d');
            const labels = Object.keys(DATA.nationalSpendingRatio);
            const data = labels.map(l => totalBurden * DATA.nationalSpendingRatio[l]);
            
            if (spendingChart) spendingChart.destroy();
            spendingChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6'],
                        borderColor: '#fff', borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 12 }, padding: 15 }},
                        tooltip: { 
                            callbacks: { 
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed;
                                    const sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / sum) * 100).toFixed(1) + '%';
                                    label += new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value);
                                    label += ` (${percentage})`;
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                             formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum);
                                if (percentage < 5) return '';
                                return `${Math.round(value/10000)}ä¸‡å††`;
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 10, }
                        }
                    }
                }
            });
        }

        // --- Event Listeners ---
        calculateBtn.addEventListener('click', calculate);
        ageInput.addEventListener('input', handleAgeChange);
        
        annualIncomeInput.addEventListener('focus', (e) => {
            e.target.value = e.target.value.replace(/,/g, '');
        });

        annualIncomeInput.addEventListener('blur', (e) => {
            const value = e.target.value.replace(/,/g, '');
            if (!isNaN(value) && value.length > 0) {
                e.target.value = new Intl.NumberFormat('ja-JP').format(value);
            }
        });
        
        window.addEventListener('scroll', () => {
            const header = document.querySelector('header');
            if (window.scrollY > 10) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });

        window.addEventListener('load', () => {
             populatePrefectures();
             handleAgeChange();
             resultContainer.classList.remove('visible');
        });

    </script>
</body>
</html>
